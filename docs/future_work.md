# 今後のテストと拡張に関する考察 (Considerations for Future Testing and Expansion)

このドキュメントは、本システムの品質向上と機能拡張に向けた、今後の具体的な作業項目をまとめたものです。

## 1. テスト戦略の強化 (Enhanced Testing Strategy)

現在の単体テストは、各コンポーネントの基本的なロジックを検証するものですが、システム全体の品質を保証するためには、より高度なテストが必要です。

### 1.1. 統合テスト (Integration Testing)

**目的**:
複数のコンポーネント（API、Agent、Vector Store）が連携して正しく動作することを確認します。

**手順**:
1.  `pytest`と`docker-compose`を連携させたテストハーネスを構築します。
2.  テスト実行前にDockerコンテナ（`backend`, `chroma`）を起動します。
3.  テスト用のドキュメントを`/tools/ingest`エンドポイント経由で取り込みます。
4.  `/api/chat`エンドポイントに特定の質問を送信し、取り込んだドキュメントの内容に基づいた回答と、正しい引用元が返されることをアサートします。
5.  テスト完了後にコンテナを破棄します。

### 1.2. LLM応答品質の評価 (LLM Response Quality Evaluation)

**目的**:
LLMエージェントが生成する回答の品質（正確性、関連性、一貫性）を評価し、継続的に改善します。

**手順**:
1.  **評価データセットの作成**: 想定される質問と、それに対する理想的な回答および引用元のペアからなる「ゴールデンデータセット」を作成します。
2.  **評価スクリプトの実装**: データセット内の各質問をシステムに投げかけ、得られた回答を理想的な回答と比較・評価するスクリプトを作成します。
3.  **評価指標**:
    -   **引用元評価**: 正しいドキュメントが引用されているか（適合率、再現率）。
    -   **回答内容評価**: Ragasのようなフレームワークを利用するか、より強力なLLM（例: GPT-4）に回答の正確性や自然さを採点させる。
4.  **プロンプトチューニング**: 評価結果に基づき、`app/agent.py`内のプロンプトを改善し、再度評価するサイクルを回します。

### 1.3. フロントエンドテスト (Frontend Testing)

**目的**:
ユーザーインターフェースのインタラクションが正しく動作することを確認します。

**手順**:
1.  **Playwright**や**Selenium**のようなブラウザ自動化ツールを導入します。
2.  「メッセージを送信し、応答が表示される」「引用元のアコーディオンが開閉する」といった典型的なユーザーシナリオをテストケースとして記述します。

## 2. 機能拡張計画 (Expansion Plan)

`docs/requirement.md`の非機能要件や将来的な展望に基づき、以下の拡張を計画します。

### 2.1. 認証機能 (Authentication)

**目的**:
セキュリティを強化し、許可されたユーザーのみがシステムを利用できるようにします。

**計画**:
-   FastAPIに**OAuth2**（Password FlowまたはAuthorization Code Flow）を導入します。
-   `/api/chat`エンドポイントを保護し、認証されたユーザーのみがアクセスできるようにします。
-   Streamlitフロントエンドにログイン画面を追加し、トークンを取得・管理するロジックを実装します。

### 2.2. ストリーミング応答 (Streaming Responses)

**目的**:
LLMが回答を生成する過程をリアルタイムでUIに表示し、ユーザーの体感待機時間を短縮します。

**計画**:
-   FastAPIの`/api/chat`エンドポイントで`StreamingResponse`を使用するように変更します。
-   LangChainエージェントの`stream`メソッドを利用し、生成されるトークンをチャンクとしてクライアントに送信します。
-   Streamlit側で、受け取ったチャンクを逐次表示するロジックを実装します。

### 2.3. 対応ドキュメント形式の拡張 (Expanded Document Support)

**目的**:
より多様な形式の社内ドキュメントに対応します。

**計画**:
-   `unstructured`ライブラリや`langchain-community`の他のドキュメントローダーを活用し、`ingest_document`ツールを拡張します。
-   対応形式の例: Microsoft Word (`.docx`), PowerPoint (`.pptx`), HTMLなど。

### 2.4. 会話履歴の活用 (Leveraging Conversation History)

**目的**:
過去のやり取りを踏まえた、より文脈に沿った回答を生成できるようにします。

**計画**:
-   `/api/chat`リクエストで受け取った`history`を、LangChainエージェントの入力（`chat_history`キーなど）として渡すように変更します。
-   エージェントのプロンプトを更新し、会話履歴を考慮して応答するように指示します。

### 2.5. LangGraphへの移行検討 (Consideration of Migrating to LangGraph)

**目的**:
ツール呼び出しが複数回に及ぶ、あるいはユーザーの意図に応じて処理フローを分岐させるなど、より複雑なエージェントを構築する必要が出てきた場合に対応します。

**計画**:
-   現在のReActエージェントでは制御が困難になった時点で、状態管理とノードベースのグラフ実行が可能な**LangGraph**への移行を検討します。
